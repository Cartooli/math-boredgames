#!/usr/bin/env node

/**
 * Convert Problem of the Week markdown to embedded JavaScript data
 * 
 * Usage:
 *   node convert-olympiad-data.js "Copy of Problem of the Week - Master Sheet.md"
 * 
 * This script parses the markdown file and generates JavaScript code
 * that can be embedded in olympiad-data.js
 */

const fs = require('fs');
const path = require('path');

// Get input file from command line
const inputFile = process.argv[2];

if (!inputFile) {
    console.error('‚ùå Error: Please provide the markdown file path');
    console.error('\nUsage:');
    console.error('  node convert-olympiad-data.js "path/to/file.md"');
    process.exit(1);
}

if (!fs.existsSync(inputFile)) {
    console.error(`‚ùå Error: File not found: ${inputFile}`);
    process.exit(1);
}

console.log('üîÑ Converting markdown to embedded JavaScript data...\n');
console.log(`üìñ Reading: ${inputFile}\n`);

try {
    // Read the markdown file
    const markdown = fs.readFileSync(inputFile, 'utf8');
    console.log(`‚úÖ Read ${markdown.length} characters\n`);
    
    // Parse the markdown (same logic as olympiad-data.js)
    const { questions, imageData } = parseMarkdown(markdown);
    
    console.log(`‚úÖ Parsed ${questions.length} questions`);
    console.log(`‚úÖ Found ${Object.keys(imageData).length} images\n`);
    
    // Generate JavaScript code
    const jsCode = generateEmbeddedData(questions, imageData);
    
    // Output file
    const outputFile = 'olympiad-data-embedded.js';
    fs.writeFileSync(outputFile, jsCode, 'utf8');
    
    console.log(`\n‚úÖ Generated: ${outputFile}`);
    console.log(`\nüìã Next steps:`);
    console.log(`   1. Open ${outputFile}`);
    console.log(`   2. Copy the EMBEDDED_OLYMPIAD_DATA object`);
    console.log(`   3. Paste it into olympiad-data.js (replace the empty one)`);
    console.log(`   4. Delete ${outputFile} (it's not needed after embedding)\n`);
    
} catch (error) {
    console.error('‚ùå Error:', error.message);
    process.exit(1);
}

function parseMarkdown(text) {
    const lines = text.split('\n');
    const questions = [];
    const imageData = {};
    let currentDate = null;
    let currentImageRef = null;
    
    // First pass: collect date-image pairs
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        // Match date headers (## Date format)
        const dateMatch = line.match(/^##\s+(.+)$/);
        if (dateMatch) {
            const dateStr = dateMatch[1].trim();
            // Only process if it looks like a date (has letters/numbers, not just symbols)
            if (dateStr && !dateStr.startsWith('![') && dateStr.length > 3 && /[a-zA-Z0-9]/.test(dateStr)) {
                currentDate = dateStr;
            }
        }
        
        // Match image references ![][imageX]
        const imageMatch = line.match(/!\[.*?\]\[(image\d+)\]/);
        if (imageMatch && currentDate) {
            currentImageRef = imageMatch[1];
            
            questions.push({
                id: questions.length + 1,
                date: currentDate,
                imageRef: currentImageRef,
                title: `Problem from ${currentDate}`
            });
            
            // Reset for next question
            currentDate = null;
        }
    }
    
    // Second pass: collect base64 image data
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        // Match image data: [imageX]: <data:image/png;base64,...>
        const imageDataMatch = line.match(/\[(image\d+)\]:\s*<(data:image\/[^;]+;base64,[^>]+)>/);
        if (imageDataMatch) {
            const imageRef = imageDataMatch[1];
            const imageDataUrl = imageDataMatch[2];
            imageData[imageRef] = imageDataUrl;
        }
    }
    
    return { questions, imageData };
}

function generateEmbeddedData(questions, imageData) {
    // Format questions as JavaScript array
    const questionsStr = JSON.stringify(questions, null, 2)
        .split('\n')
        .map((line, i) => i === 0 ? line : '    ' + line)
        .join('\n');
    
    // Format imageData as JavaScript object
    // Since imageData contains very long base64 strings, we'll format it carefully
    const imageDataEntries = Object.entries(imageData);
    const imageDataLines = imageDataEntries.map(([key, value]) => {
        // Truncate the base64 string in the output for readability (but keep full value)
        const preview = value.substring(0, 50) + '...';
        return `        "${key}": "${value}"`;
    });
    
    const imageDataStr = imageDataLines.length > 0 
        ? `{\n${imageDataLines.join(',\n')}\n    }`
        : '{}';
    
    return `// Embedded Olympiad Data
// Generated by convert-olympiad-data.js
// DO NOT EDIT MANUALLY - Regenerate using the conversion script

const EMBEDDED_OLYMPIAD_DATA = {
    questions: ${questionsStr},
    imageData: ${imageDataStr}
};

// Export for use in olympiad-data.js
if (typeof module !== 'undefined' && module.exports) {
    module.exports = EMBEDDED_OLYMPIAD_DATA;
}
`;
}



