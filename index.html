<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="description" content="Free, open-source K-12 math learning and practice application. Master math concepts from kindergarten to calculus with lessons, walkthroughs, and unlimited practice problems.">
    <meta name="keywords" content="math, education, learning, practice, K-12, free, open-source, mathematics, algebra, geometry, calculus">
    <meta name="author" content="MathBored Project">
    <title>MathBored - Never Be Bored with Math Again</title>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://math.boredgames.site/">
    <meta property="og:title" content="MathBored - Never Be Bored with Math Again">
    <meta property="og:description" content="Free, open-source K-12 math learning and practice application. Master math concepts from kindergarten to calculus with lessons, walkthroughs, and unlimited practice problems.">
    <meta property="og:image" content="https://math.boredgames.site/og-image.png?v=2">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="MathBored - Free K-12 Math Learning Platform">
    <meta property="og:site_name" content="MathBored">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://math.boredgames.site/">
    <meta property="twitter:title" content="MathBored - Never Be Bored with Math Again">
    <meta property="twitter:description" content="Free, open-source K-12 math learning and practice application. Master math concepts from kindergarten to calculus with lessons, walkthroughs, and unlimited practice problems.">
    <meta property="twitter:image" content="https://math.boredgames.site/og-image.png?v=2">
    <meta property="twitter:image:alt" content="MathBored - Free K-12 Math Learning Platform">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://math.boredgames.site/">
    
    <!-- Structured Data (JSON-LD) for SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "MathBored",
        "description": "Free, open-source K-12 math learning and practice application. Master math concepts from kindergarten to calculus with lessons, walkthroughs, and unlimited practice problems.",
        "url": "https://math.boredgames.site/",
        "applicationCategory": "EducationalApplication",
        "operatingSystem": "Any",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "provider": {
            "@type": "Organization",
            "name": "MathBored",
            "url": "https://math.boredgames.site",
            "logo": "https://math.boredgames.site/icon.svg"
        },
        "inLanguage": "en-US",
        "isAccessibleForFree": true,
        "audience": {
            "@type": "EducationalAudience",
            "educationalRole": "student",
            "audienceType": "K-12 Students"
        },
        "featureList": [
            "K-12 Math Lessons",
            "Interactive Walkthroughs",
            "Unlimited Practice Problems",
            "Progress Tracking",
            "Multiple Difficulty Levels",
            "No Login Required",
            "Completely Free"
        ]
    }
    </script>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon.svg">
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MathBored">
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Fallback for users without JavaScript -->
    <noscript>
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #0f172a; color: #f1f5f9; display: flex; align-items: center; justify-content: center; z-index: 99999; padding: 20px;">
            <div style="max-width: 500px; text-align: center; background: #1e293b; padding: 40px; border-radius: 16px; border: 2px solid #475569;">
                <div style="font-size: 4rem; margin-bottom: 20px;">âš ï¸</div>
                <h2 style="font-size: 2rem; margin-bottom: 20px; color: #3b82f6;">JavaScript Required</h2>
                <p style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 20px;">MathBored requires JavaScript to provide an interactive learning experience. Please enable JavaScript in your browser settings to continue.</p>
                <p style="font-size: 0.9rem; color: #94a3b8;">If you're unsure how to enable JavaScript, search for "enable JavaScript" followed by your browser name (Chrome, Firefox, Safari, etc.).</p>
            </div>
        </div>
    </noscript>
    <!-- Quick Start Modal -->
    <div id="quickStartModal" class="quick-start-modal">
        <div class="modal-overlay" onclick="quickStartModal.close()" aria-label="Close modal" tabindex="-1"></div>
        <div class="modal-content">
            <button class="modal-close" onclick="quickStartModal.close()" aria-label="Close">&times;</button>
            <div class="modal-hero">
                <div class="hero-icon">ğŸš€</div>
                <h2>Welcome to MathBored!</h2>
                <p>Let's find the perfect starting point for your math journey</p>
            </div>
            <div class="modal-actions">
                <button class="btn-primary" onclick="quickStartModal.startAssessment()">
                    <span class="btn-icon">âš¡</span>
                    <span class="btn-text">
                        <strong>Start Quick Assessment</strong>
                        <small>10 questions â€¢ 2-3 minutes</small>
                    </span>
                </button>
                <button class="btn-secondary" onclick="quickStartModal.close()">
                    <span>Explore Topics</span>
                </button>
            </div>
            <div class="modal-footer">
                <label class="checkbox-label">
                    <input type="checkbox" id="dontShowAgain" onchange="quickStartModal.updatePreference()">
                    <span>Don't show this again</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="modal-overlay" onclick="confirmModal.close()" aria-label="Close modal" tabindex="-1"></div>
        <div class="modal-content confirm-modal-content">
            <div class="confirm-icon">âš ï¸</div>
            <h3 class="confirm-title" id="confirmTitle">Confirm Action</h3>
            <p class="confirm-message" id="confirmMessage">Are you sure you want to proceed?</p>
            <div class="confirm-actions">
                <button class="btn-confirm-cancel" id="confirmCancel" onclick="confirmModal.close()">Cancel</button>
                <button class="btn-confirm-ok" id="confirmOk" onclick="confirmModal.onConfirm()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Assessment Mode Full Screen -->
    <div id="assessmentMode" class="assessment-mode">
        <div class="assessment-container">
            <div class="assessment-header">
                <div class="assessment-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="assessmentProgress"></div>
                    </div>
                    <div class="progress-text" id="assessmentProgressText">Question 1 of 10</div>
                </div>
                <button class="btn-exit" onclick="assessmentMode.exit()" aria-label="Exit assessment">
                    âœ•
                </button>
            </div>
            <div class="assessment-content" id="assessmentContent">
                <!-- Dynamic content loads here -->
            </div>
        </div>
    </div>

    <header>
        <div class="container">
            <div class="header-content">
                <div>
                    <h1>ğŸ¯ MathBored</h1>
                    <div class="tagline">Never be bored with math again â€¢ Always free, always helpful â€¢ <a href="demo.html">Try Demo</a> â€¢ <a href="primer.html">ğŸ“š Math Primer</a> â€¢ <a href="glossary.html">ğŸ“– Glossary</a> â€¢ <a href="#" id="quickStartLink">âš¡ Quick Start</a></div>
                </div>
                <div class="header-actions">
                    <button class="search-trigger-btn" id="searchTriggerBtn" aria-label="Search all topics" title="Search all topics">
                        <span class="search-trigger-icon">ğŸ”</span>
                        <span class="search-trigger-text">Search</span>
                    </button>
                    <div class="theme-selector">
                        <div class="theme-btn theme-midnight active" data-theme="" title="Midnight"></div>
                        <div class="theme-btn theme-ocean" data-theme="ocean" title="Ocean"></div>
                        <div class="theme-btn theme-forest" data-theme="forest" title="Forest"></div>
                        <div class="theme-btn theme-sunset" data-theme="sunset" title="Sunset"></div>
                        <div class="theme-btn theme-purple" data-theme="purple" title="Purple"></div>
                        <div class="theme-btn theme-light" data-theme="light" title="Light"></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Search Modal Overlay -->
    <div class="search-modal" id="searchModal">
        <div class="search-modal-backdrop" id="searchModalBackdrop"></div>
        <div class="search-modal-content">
            <div class="search-modal-header">
                <h2 class="search-modal-title">ğŸ” Search MathBored</h2>
                <button class="search-modal-close" id="searchModalClose" aria-label="Close search">Ã—</button>
            </div>
            <div class="search-modal-body">
                <div class="search-input-wrapper">
                    <input 
                        type="text" 
                        id="modalSearchInput" 
                        class="search-modal-input" 
                        placeholder="Try 'multiplying fractions' or 'quadratic equations'..."
                        autocomplete="off"
                        aria-label="Search math topics"
                    >
                    <button class="search-input-clear" id="modalSearchClear" aria-label="Clear search">Ã—</button>
                </div>
                <div class="search-suggestions">
                    <span class="suggestion-label">Popular:</span>
                    <button class="suggestion-chip" data-query="fractions">Fractions</button>
                    <button class="suggestion-chip" data-query="multiplication">Multiplication</button>
                    <button class="suggestion-chip" data-query="algebra">Algebra</button>
                    <button class="suggestion-chip" data-query="geometry">Geometry</button>
                    <button class="suggestion-chip" data-query="pythagorean">Pythagorean</button>
                </div>
                <div class="search-results-container" id="searchResultsContainer">
                    <div class="search-results-count" id="searchResultsCount"></div>
                    <div class="search-results-grid" id="searchResultsGrid">
                        <!-- Results will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="controls">
            <div class="control-group">
                <label for="gradeSelect">ğŸ“š Grade Level</label>
                <select id="gradeSelect">
                    <option value="K">Kindergarten</option>
                    <option value="1">1st Grade</option>
                    <option value="2">2nd Grade</option>
                    <option value="3">3rd Grade</option>
                    <option value="4">4th Grade</option>
                    <option value="5" selected>5th Grade</option>
                    <option value="6">6th Grade</option>
                    <option value="7">7th Grade</option>
                    <option value="8">8th Grade</option>
                    <option value="9">9th Grade (Algebra I)</option>
                    <option value="10">10th Grade (Geometry)</option>
                    <option value="11">11th Grade (Algebra II)</option>
                    <option value="12">12th Grade (Pre-Calculus/Calculus)</option>
                </select>
            </div>

            <div class="control-group">
                <label for="topicSelect">ğŸ“– Topic</label>
                <div class="topic-search-wrapper">
                    <input type="text" 
                           id="topicSearch" 
                           placeholder="ğŸ” Search topics..." 
                           class="topic-search-input"
                           oninput="app.enhancedFilterTopics(this.value)"
                           aria-label="Search topics">
                    <button id="searchClearBtn" class="search-clear-btn" onclick="app.clearTopicSearch()" aria-label="Clear search">Ã—</button>
                </div>
                <div id="searchResultsInfo" class="search-results-info" style="display: none;"></div>
                <select id="topicSelect"></select>
            </div>
            
            <!-- Recently Viewed Topics -->
            <div id="recentlyViewedContainer" class="recently-viewed-container" style="display: none;">
                <div class="recently-viewed-header">
                    <span class="recently-viewed-icon">ğŸ•’</span>
                    <span class="recently-viewed-title">Recently Viewed</span>
                </div>
                <div class="recently-viewed-list"></div>
            </div>

            <div class="control-group">
                <label id="modeLabel">ğŸ® Learning Mode</label>
                <div class="mode-tabs" role="group" aria-labelledby="modeLabel">
                    <button class="mode-tab active" data-mode="lesson">ğŸ“ Lesson</button>
                    <button class="mode-tab" data-mode="walkthrough">ğŸ” Walkthrough</button>
                    <button class="mode-tab" data-mode="practice">ğŸ’ª Practice</button>
                </div>
            </div>

            <div class="control-group" id="difficultyControl" style="display: none;">
                <label id="difficultyLabel">âš¡ Difficulty Level</label>
                <div class="mode-tabs" role="group" aria-labelledby="difficultyLabel">
                    <button class="difficulty-tab" data-difficulty="easy">ğŸ˜Š Easy</button>
                    <button class="difficulty-tab active" data-difficulty="medium">ğŸ˜ Medium</button>
                    <button class="difficulty-tab" data-difficulty="hard">ğŸ”¥ Hard</button>
                </div>
            </div>

            <!-- Adaptive Difficulty Toggle -->
            <div class="control-group" id="adaptiveControl">
                <label id="adaptiveLabel">ğŸ¤– Adaptive Learning</label>
                <button 
                    id="adaptiveToggle" 
                    class="adaptive-toggle"
                    onclick="app.toggleAdaptiveDifficulty()"
                    aria-label="Toggle adaptive difficulty">
                    â—‹ Adaptive Mode OFF
                </button>
                <div class="adaptive-info">
                    <small>When enabled, problem difficulty adjusts automatically based on your performance</small>
                </div>
            </div>

            <div class="stats-panel">
                <div class="stat-item">
                    <span class="stat-label">Streak</span>
                    <span class="stat-value" id="streakCount" aria-live="polite" aria-atomic="true">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Score</span>
                    <span class="stat-value" id="scoreCount" aria-live="polite" aria-atomic="true">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Accuracy</span>
                    <span class="stat-value" id="accuracyPercent" aria-live="polite" aria-atomic="true">--%</span>
                </div>
                <button class="share-btn" id="shareBtn" onclick="app.shareStats()" title="Share your progress">
                    ğŸ“¤ Share Progress
                </button>
                <button class="reset-btn" id="resetBtn" onclick="app.resetStats()" title="Reset all statistics">
                    ğŸ”„ Reset Stats
                </button>
                <button class="export-btn" onclick="app.exportProgress()" title="Download your progress">
                    ğŸ’¾ Export Progress
                </button>
                <button class="import-btn" onclick="app.importProgress()" title="Restore from backup">
                    ğŸ“‚ Import Progress
                </button>
                <button class="achievements-btn" onclick="app.viewAchievements()" title="View your achievements">
                    ğŸ† Achievements
                </button>
                <button class="timed-btn" onclick="app.startTimedChallenge(300)" title="Start 5-minute timed challenge">
                    â±ï¸ Timed Challenge
                </button>
                <button class="print-btn" onclick="app.printWorksheet()" title="Print current worksheet">
                    ğŸ–¨ï¸ Print
                </button>
                <button class="analytics-btn" onclick="app.viewAnalytics()" title="View usage analytics">
                    ğŸ“Š Analytics
                </button>
            </div>
            
            <!-- Learning Tools -->
            <div class="learning-tools" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border);">
                <h3 style="font-size: 1rem; margin-bottom: 12px; color: var(--text-secondary); text-align: center;">ğŸ› ï¸ Learning Tools</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                    <button class="export-btn" onclick="app.showGraphPlotter()" title="Interactive graph plotter">
                        ğŸ“Š Graph Plotter
                    </button>
                    <button class="export-btn" onclick="app.showNumberLineDemo()" title="Visual number line">
                        ğŸ“ Number Line
                    </button>
                </div>
            </div>
        </div>

        <!-- Breadcrumb Navigation (SEO-friendly) -->
        <nav aria-label="Breadcrumb" id="breadcrumbNav" class="breadcrumb-nav" style="display: none;">
            <ol class="breadcrumb-list">
                <li class="breadcrumb-item">
                    <a href="/" class="breadcrumb-link">ğŸ  Home</a>
                </li>
                <li class="breadcrumb-separator" aria-hidden="true">/</li>
                <li class="breadcrumb-item">
                    <span id="breadcrumbGrade" class="breadcrumb-text"></span>
                </li>
                <li class="breadcrumb-separator" aria-hidden="true">/</li>
                <li class="breadcrumb-item breadcrumb-current">
                    <span id="breadcrumbTopic" class="breadcrumb-topic"></span>
                </li>
                <li class="breadcrumb-separator" aria-hidden="true">â€¢</li>
                <li class="breadcrumb-item">
                    <span id="breadcrumbMode" class="breadcrumb-mode"></span>
                </li>
            </ol>
        </nav>

        <div class="content-area" id="contentArea" role="main" aria-live="polite">
            <!-- Content loads here dynamically -->
        </div>
    </div>

    <footer>
        <div class="container">
            <p>MathBored @ math.boredgames.site â€¢ Free forever â€¢ No logins, no limits, just learning</p>
            <p style="margin-top: 10px; font-size: 0.9rem;">
                Helping students master math, one problem at a time ğŸš€
                <br>
                <a href="competitions.html" style="color: var(--accent); text-decoration: none; font-weight: 600;">ğŸ† Explore Math Competitions</a>
                â€¢
                <a href="olympiad.html" style="color: var(--accent); text-decoration: none; font-weight: 600;">ğŸ“ Daily Math Olympiad</a>
                <br>
                <span style="font-size: 0.8rem; opacity: 0.8; margin-top: 5px; display: inline-block;">
                    ğŸ”’ Your feedback is completely anonymous and private
                </span>
            </p>
        </div>
    </footer>

    <!-- Floating Feedback Menu -->
    <div class="feedback-container">
        <button class="feedback-button" id="feedbackBtn" title="Feedback & Roadmap">
            ğŸ’¬
        </button>
        <div class="feedback-menu" id="feedbackMenu">
            <a href="https://forms.gle/EgVZZT9ybtyJXHscA" target="_blank" rel="noopener noreferrer" class="feedback-menu-item">
                <span class="menu-icon">ğŸ’¬</span>
                <div class="menu-content">
                    <div class="menu-title">Anonymous Feedback</div>
                    <div class="menu-desc">Report bugs, share thoughts</div>
                </div>
            </a>
            <a href="roadmap.html" class="feedback-menu-item">
                <span class="menu-icon">ğŸ—ºï¸</span>
                <div class="menu-content">
                    <div class="menu-title">Feature Roadmap</div>
                    <div class="menu-desc">View & vote on upcoming features</div>
                </div>
            </a>
            <a href="https://github.com/Cartooli/math-boredgames/discussions" target="_blank" rel="noopener noreferrer" class="feedback-menu-item">
                <span class="menu-icon">ğŸ’¡</span>
                <div class="menu-content">
                    <div class="menu-title">Suggest Feature</div>
                    <div class="menu-desc">Share your ideas on GitHub</div>
                </div>
            </a>
        </div>
    </div>

    <!-- Competitions Widget -->
    <div class="competitions-widget" id="competitionsWidget">
        <button class="widget-close" onclick="competitionsWidget.close()" aria-label="Close">Ã—</button>
        <div class="widget-content">
            <div class="widget-icon">ğŸ†</div>
            <h3 class="widget-title">Ready for a Challenge?</h3>
            <p class="widget-description">Discover nationwide math competitions for K-8 students. Test your skills against peers across the U.S.!</p>
            <a href="competitions.html" class="widget-cta">Explore Competitions â†’</a>
        </div>
        <div class="widget-footer">
            MATHCOUNTS â€¢ AMC 8 â€¢ MOEMS & more
        </div>
    </div>

    <script src="data.js?v=5"></script>
    <script src="app.js?v=5"></script>
    <!-- Fuse.js for fuzzy search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>
    <!-- Search Index -->
    <script src="search-index.js?v=1"></script>
    <script>
    // ============================================
    // SEARCH MODAL CONTROLLER
    // ============================================
    const searchModal = {
        fuse: null,
        debounceTimer: null,
        isOpen: false,
        
        init() {
            // Wait for search index to be ready
            if (!searchIndex || !searchIndex.data || searchIndex.data.length === 0) {
                setTimeout(() => this.init(), 100);
                return;
            }
            
            // Initialize Fuse.js with search index
            this.fuse = new Fuse(searchIndex.data, {
                keys: [
                    { name: 'title', weight: 0.4 },
                    { name: 'description', weight: 0.3 },
                    { name: 'keywords', weight: 0.3 }
                ],
                threshold: 0.4,
                ignoreLocation: true,
                includeScore: true,
                minMatchCharLength: 2
            });
            
            // Bind trigger button
            const triggerBtn = document.getElementById('searchTriggerBtn');
            if (triggerBtn) {
                triggerBtn.addEventListener('click', () => this.open());
            }
            
            // Bind modal events
            const modal = document.getElementById('searchModal');
            const backdrop = document.getElementById('searchModalBackdrop');
            const closeBtn = document.getElementById('searchModalClose');
            const input = document.getElementById('modalSearchInput');
            const clearBtn = document.getElementById('modalSearchClear');
            const suggestions = document.querySelectorAll('.search-modal .suggestion-chip');
            
            if (backdrop) {
                backdrop.addEventListener('click', () => this.close());
            }
            
            if (closeBtn) {
                closeBtn.addEventListener('click', () => this.close());
            }
            
            if (input) {
                input.addEventListener('input', (e) => this.handleInput(e.target.value));
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.close();
                    }
                });
            }
            
            if (clearBtn) {
                clearBtn.addEventListener('click', () => this.clearSearch());
            }
            
            suggestions.forEach(chip => {
                chip.addEventListener('click', () => {
                    const query = chip.dataset.query;
                    if (input) {
                        input.value = query;
                        this.search(query);
                    }
                });
            });
            
            // Global keyboard shortcut: Cmd/Ctrl + K to open search
            document.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    if (this.isOpen) {
                        this.close();
                    } else {
                        this.open();
                    }
                }
            });
            
            console.log('âœ… Search modal initialized (Cmd/Ctrl+K to open)');
        },
        
        open() {
            const modal = document.getElementById('searchModal');
            const input = document.getElementById('modalSearchInput');
            
            if (modal) {
                modal.classList.add('open');
                document.body.style.overflow = 'hidden';
                this.isOpen = true;
                
                // Focus input after animation
                setTimeout(() => {
                    if (input) input.focus();
                }, 100);
            }
        },
        
        close() {
            const modal = document.getElementById('searchModal');
            
            if (modal) {
                modal.classList.remove('open');
                document.body.style.overflow = '';
                this.isOpen = false;
                this.clearSearch();
            }
        },
        
        handleInput(value) {
            // Show/hide clear button
            const clearBtn = document.getElementById('modalSearchClear');
            if (clearBtn) {
                clearBtn.style.display = value.length > 0 ? 'flex' : 'none';
            }
            
            // Debounce search
            clearTimeout(this.debounceTimer);
            this.debounceTimer = setTimeout(() => {
                if (value.length >= 2) {
                    this.search(value);
                } else {
                    this.hideResults();
                }
            }, 150);
        },
        
        search(query) {
            if (!this.fuse) return;
            
            const results = this.fuse.search(query, { limit: 15 });
            this.renderResults(results, query);
        },
        
        renderResults(results, query) {
            const container = document.getElementById('searchResultsContainer');
            const grid = document.getElementById('searchResultsGrid');
            const countEl = document.getElementById('searchResultsCount');
            
            if (!container || !grid) return;
            
            if (results.length === 0) {
                countEl.textContent = `No results for "${query}"`;
                grid.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">ğŸ”</div>
                        <p>No topics found for "<strong>${this.escapeHtml(query)}</strong>"</p>
                        <p class="no-results-hint">Try different keywords or close to browse by grade level</p>
                    </div>
                `;
                container.classList.add('has-results');
                return;
            }
            
            countEl.textContent = `${results.length} result${results.length !== 1 ? 's' : ''} for "${query}"`;
            
            grid.innerHTML = results.map(result => this.renderCard(result.item)).join('');
            container.classList.add('has-results');
        },
        
        renderCard(item) {
            const typeIcons = {
                'topic': 'ğŸ“š',
                'primer': 'ğŸ“–',
                'olympiad': 'ğŸ†',
                'competitions': 'ğŸ¥‡',
                'reference': 'ğŸ“‹'
            };
            
            const typeLabels = {
                'topic': 'Math Topic',
                'primer': 'Primer Lesson',
                'olympiad': 'Challenge',
                'competitions': 'Competitions',
                'reference': 'Reference'
            };
            
            const icon = typeIcons[item.type] || 'ğŸ“';
            const typeLabel = typeLabels[item.type] || 'Content';
            
            // Build links section based on available links
            let linksHtml = '';
            if (item.links) {
                const linkItems = [];
                if (item.links.lesson) {
                    linkItems.push(`<a href="${item.links.lesson}" class="result-link result-link-lesson">ğŸ“ Lesson</a>`);
                }
                if (item.links.practice) {
                    linkItems.push(`<a href="${item.links.practice}" class="result-link result-link-practice">ğŸ’ª Practice</a>`);
                }
                if (item.links.walkthrough) {
                    linkItems.push(`<a href="${item.links.walkthrough}" class="result-link result-link-walkthrough">ğŸ” Walkthrough</a>`);
                }
                if (item.links.primer) {
                    linkItems.push(`<a href="${item.links.primer}" class="result-link result-link-primer">ğŸ“– Primer</a>`);
                }
                if (item.links.olympiad) {
                    linkItems.push(`<a href="${item.links.olympiad}" class="result-link result-link-olympiad">ğŸ† Challenge</a>`);
                }
                if (item.links.competitions) {
                    linkItems.push(`<a href="${item.links.competitions}" class="result-link result-link-competitions">ğŸ¥‡ Explore</a>`);
                }
                if (item.links.glossary) {
                    linkItems.push(`<a href="${item.links.glossary}" class="result-link result-link-glossary">ğŸ“– Glossary</a>`);
                }
                linksHtml = linkItems.join('');
            }
            
            return `
                <div class="search-result-card" data-type="${item.type}">
                    <div class="result-header">
                        <span class="result-icon">${icon}</span>
                        <span class="result-type">${typeLabel}</span>
                        <span class="result-grade">${item.gradeLabel}</span>
                    </div>
                    <h3 class="result-title">${this.escapeHtml(item.title)}</h3>
                    <p class="result-description">${this.escapeHtml(item.description)}</p>
                    <div class="result-links">
                        ${linksHtml}
                    </div>
                </div>
            `;
        },
        
        escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        },
        
        clearSearch() {
            const input = document.getElementById('modalSearchInput');
            const clearBtn = document.getElementById('modalSearchClear');
            
            if (input) input.value = '';
            if (clearBtn) clearBtn.style.display = 'none';
            
            this.hideResults();
        },
        
        hideResults() {
            const container = document.getElementById('searchResultsContainer');
            if (container) {
                container.classList.remove('has-results');
            }
        }
    };
    
    // Initialize search modal
    document.addEventListener('DOMContentLoaded', () => {
        searchModal.init();
    });
    </script>
    <script>
    // ============================================
    // QUICK START MODAL CONTROLLER
    // ============================================
    const quickStartModal = {
        show() {
            const modal = document.getElementById('quickStartModal');
            if (modal) {
                // Reset all styles first
                modal.style.display = 'flex';
                modal.style.visibility = '';
                modal.style.opacity = '';
                // Then add show class for transition
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                
                // Focus trap: focus first interactive element
                setTimeout(() => {
                    const focusableElements = modal.querySelectorAll(
                        'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
                    );
                    if (focusableElements.length > 0) {
                        focusableElements[0].focus();
                    }
                }, 100);
            }
        },
        
        close() {
            const modal = document.getElementById('quickStartModal');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = '';
                // Ensure modal is completely hidden after animation
                setTimeout(() => {
                    if (!modal.classList.contains('show')) {
                        modal.style.display = 'none';
                    }
                }, 350); // Wait for animation to complete (300ms + buffer)
            }
        },
        
        startAssessment() {
            // Immediately hide modal completely (no transition delay)
            const modal = document.getElementById('quickStartModal');
            if (modal) {
                // Remove show class and force all hiding properties immediately
                modal.classList.remove('show');
                modal.style.display = 'none';
                modal.style.visibility = 'hidden';
                modal.style.opacity = '0';
                modal.style.pointerEvents = 'none'; // Prevent any interaction
                document.body.style.overflow = '';
            }
            // Start assessment immediately - modal is completely hidden
            assessmentMode.start();
        },
        
        updatePreference() {
            const checkbox = document.getElementById('dontShowAgain');
            if (checkbox && checkbox.checked) {
                localStorage.setItem('hideQuickStart', 'true');
            } else {
                localStorage.removeItem('hideQuickStart');
            }
        },
        
        init() {
            // Show modal on first visit (unless user opted out)
            const hideQuickStart = localStorage.getItem('hideQuickStart');
            if (!hideQuickStart) {
                // Show after a brief delay for better UX
                setTimeout(() => this.show(), 500);
            }
            
            // Add quick start link handler
            const quickStartLink = document.getElementById('quickStartLink');
            if (quickStartLink) {
                quickStartLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.show();
                });
            }
        }
    };
    
    // ============================================
    // CONFIRMATION MODAL CONTROLLER
    // ============================================
    const confirmModal = {
        onConfirmCallback: null,
        
        show(options) {
            const modal = document.getElementById('confirmModal');
            const title = document.getElementById('confirmTitle');
            const message = document.getElementById('confirmMessage');
            
            if (modal && title && message) {
                title.textContent = options.title || 'Confirm Action';
                message.textContent = options.message || 'Are you sure you want to proceed?';
                this.onConfirmCallback = options.onConfirm || null;
                
                // Ensure modal appears on top
                modal.style.display = 'flex';
                modal.style.zIndex = '10002';
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                
                // Focus trap: focus the confirm button
                setTimeout(() => {
                    const confirmBtn = document.getElementById('confirmOk');
                    if (confirmBtn) {
                        confirmBtn.focus();
                    }
                }, 100);
                
                console.log('âœ… Confirmation modal shown');
            } else {
                console.error('âŒ Confirmation modal elements not found');
            }
        },
        
        close() {
            const modal = document.getElementById('confirmModal');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = '';
                setTimeout(() => {
                    if (!modal.classList.contains('show')) {
                        modal.style.display = 'none';
                    }
                }, 300);
            }
            this.onConfirmCallback = null;
        },
        
        onConfirm() {
            if (this.onConfirmCallback) {
                this.onConfirmCallback();
            }
            this.close();
        }
    };
    
    // ============================================
    // ASSESSMENT MODE CONTROLLER
    // ============================================
    const assessmentMode = {
        questions: [],
        currentQuestion: 0,
        score: 0,
        answers: [],
        
        // Helper to generate random integer
        randomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        },
        
        // Helper to pick random item from array
        randomFrom(array) {
            return array[Math.floor(Math.random() * array.length)];
        },
        
        // Generate fresh questions for each assessment
        generateQuestions() {
            return [
                this.generateSingleDigitAddition(),
                this.generateTwoDigitAddition(),
                this.generateMultiplication(),
                this.generateFraction(),
                this.generateArea(),
                this.generatePercentage(),
                this.generateEquation(),
                this.generateInteger(),
                this.generatePythagorean(),
                this.generateSlope()
            ];
        },
        
        generateSingleDigitAddition() {
            const a = this.randomInt(1, 9);
            const b = this.randomInt(1, 9);
            return {
                level: 'K-1',
                text: `${a} + ${b} = ?`,
                answer: a + b,
                type: 'numeric',
                topic: 'Single Digit Addition'
            };
        },
        
        generateTwoDigitAddition() {
            const a = this.randomInt(10, 89);
            const b = this.randomInt(10, 50);
            return {
                level: '2nd',
                text: `${a} + ${b} = ?`,
                answer: a + b,
                type: 'numeric',
                topic: 'Two-Digit Addition'
            };
        },
        
        generateMultiplication() {
            const a = this.randomInt(2, 12);
            const b = this.randomInt(2, 12);
            return {
                level: '3rd',
                text: `${a} Ã— ${b} = ?`,
                answer: a * b,
                type: 'numeric',
                topic: 'Multiplication Tables'
            };
        },
        
        generateFraction() {
            // Common fraction pairs that result in nice decimals
            const problems = [
                { text: 'What is 1/2 + 1/4? (Enter as a decimal)', answer: 0.75 },
                { text: 'What is 1/4 + 1/4? (Enter as a decimal)', answer: 0.5 },
                { text: 'What is 3/4 - 1/4? (Enter as a decimal)', answer: 0.5 },
                { text: 'What is 1/2 + 1/2? (Enter as a decimal)', answer: 1 },
                { text: 'What is 3/4 + 1/4? (Enter as a decimal)', answer: 1 },
                { text: 'What is 1/5 + 1/5? (Enter as a decimal)', answer: 0.4 }
            ];
            const problem = this.randomFrom(problems);
            return {
                level: '4th',
                text: problem.text,
                answer: problem.answer,
                type: 'numeric',
                topic: 'Fractions'
            };
        },
        
        generateArea() {
            const shapes = ['rectangle', 'square'];
            const shape = this.randomFrom(shapes);
            
            if (shape === 'rectangle') {
                const length = this.randomInt(5, 15);
                const width = this.randomInt(3, 12);
                return {
                    level: '5th',
                    text: `If a rectangle has length ${length} and width ${width}, what is its area?`,
                    answer: length * width,
                    type: 'numeric',
                    topic: 'Area'
                };
            } else {
                const side = this.randomInt(4, 12);
                return {
                    level: '5th',
                    text: `If a square has a side length of ${side}, what is its area?`,
                    answer: side * side,
                    type: 'numeric',
                    topic: 'Area'
                };
            }
        },
        
        generatePercentage() {
            const percentages = [10, 20, 25, 50, 75];
            const percent = this.randomFrom(percentages);
            const number = this.randomInt(20, 100);
            
            // Ensure clean result
            const cleanNumbers = {
                10: [20, 30, 40, 50, 60, 70, 80, 90, 100],
                20: [20, 25, 30, 35, 40, 45, 50, 60, 80, 100],
                25: [20, 40, 60, 80, 100],
                50: [20, 30, 40, 50, 60, 70, 80, 90, 100],
                75: [20, 40, 60, 80, 100]
            };
            
            const validNumber = this.randomFrom(cleanNumbers[percent]);
            const answer = (percent / 100) * validNumber;
            
            return {
                level: '6th',
                text: `What is ${percent}% of ${validNumber}?`,
                answer: answer,
                type: 'numeric',
                topic: 'Percentages'
            };
        },
        
        generateEquation() {
            const coef = this.randomInt(2, 5);
            const constant = this.randomInt(3, 10);
            const x = this.randomInt(2, 8);
            const result = coef * x + constant;
            
            return {
                level: '6th-7th',
                text: `Solve for x: ${coef}x + ${constant} = ${result}`,
                answer: x,
                type: 'numeric',
                topic: 'Simple Equations'
            };
        },
        
        generateInteger() {
            const operations = [
                { a: this.randomInt(-15, -5), b: this.randomInt(10, 20) },
                { a: this.randomInt(-10, -3), b: this.randomInt(5, 15) },
                { a: this.randomInt(5, 15), b: this.randomInt(-12, -3) }
            ];
            const op = this.randomFrom(operations);
            
            return {
                level: '7th',
                text: `What is ${op.a} + ${op.b}?`,
                answer: op.a + op.b,
                type: 'numeric',
                topic: 'Integers'
            };
        },
        
        generatePythagorean() {
            // Common Pythagorean triples
            const triples = [
                [3, 4, 5],
                [5, 12, 13],
                [6, 8, 10],
                [8, 15, 17],
                [9, 12, 15]
            ];
            const triple = this.randomFrom(triples);
            
            // Randomly ask for different sides
            const askFor = this.randomFrom(['hypotenuse', 'leg']);
            
            if (askFor === 'hypotenuse') {
                return {
                    level: '8th',
                    text: `A right triangle has legs of ${triple[0]} and ${triple[1]}. What is the hypotenuse?`,
                    answer: triple[2],
                    type: 'numeric',
                    topic: 'Pythagorean Theorem'
                };
            } else {
                return {
                    level: '8th',
                    text: `A right triangle has a hypotenuse of ${triple[2]} and one leg of ${triple[0]}. What is the other leg?`,
                    answer: triple[1],
                    type: 'numeric',
                    topic: 'Pythagorean Theorem'
                };
            }
        },
        
        generateSlope() {
            const x1 = this.randomInt(1, 5);
            const y1 = this.randomInt(1, 5);
            const rise = this.randomInt(2, 6);
            const run = this.randomInt(2, 4);
            const x2 = x1 + run;
            const y2 = y1 + rise;
            const slope = rise / run;
            
            // Use integer slopes for simplicity
            const simpleSlopes = [
                { x1: 1, y1: 2, x2: 3, y2: 6, slope: 2 },
                { x1: 2, y1: 3, x2: 4, y2: 7, slope: 2 },
                { x1: 1, y1: 1, x2: 4, y2: 10, slope: 3 },
                { x1: 2, y1: 5, x2: 5, y2: 11, slope: 2 },
                { x1: 1, y1: 3, x2: 3, y2: 9, slope: 3 }
            ];
            
            const problem = this.randomFrom(simpleSlopes);
            
            return {
                level: '8th',
                text: `What is the slope of a line passing through (${problem.x1}, ${problem.y1}) and (${problem.x2}, ${problem.y2})?`,
                answer: problem.slope,
                type: 'numeric',
                topic: 'Slope'
            };
        },
        
        start() {
            this.currentQuestion = 0;
            this.score = 0;
            this.answers = [];
            
            // Generate fresh questions for this assessment
            this.questions = this.generateQuestions();
            console.log('ğŸ¯ Generated fresh assessment questions:', this.questions.map(q => q.topic).join(', '));
            
            const container = document.getElementById('assessmentMode');
            if (container) {
                container.classList.add('active');
                document.body.style.overflow = 'hidden';
                this.showQuestion();
            }
        },
        
        exit() {
            // Use custom confirmation modal
            console.log('Exit assessment clicked, showing confirmation modal...');
            confirmModal.show({
                title: 'Exit Assessment?',
                message: 'Are you sure you want to exit the assessment? Your progress will be lost.',
                onConfirm: () => {
                    console.log('User confirmed exit');
                    this.closeAssessment();
                }
            });
        },
        
        closeAssessment() {
            const container = document.getElementById('assessmentMode');
            if (container) {
                container.classList.remove('active');
                document.body.style.overflow = '';
            }
        },
        
        showQuestion() {
            try {
                const question = this.questions[this.currentQuestion];
                const content = document.getElementById('assessmentContent');
                const progress = document.getElementById('assessmentProgress');
                const progressText = document.getElementById('assessmentProgressText');
                
                if (!content) {
                    console.error('Assessment content element not found');
                    return;
                }
                
                // Update progress
                const percent = ((this.currentQuestion + 1) / this.questions.length) * 100;
                if (progress) progress.style.width = percent + '%';
                if (progressText) progressText.textContent = `Question ${this.currentQuestion + 1} of ${this.questions.length}`;
                
                // Render question
                content.innerHTML = `
                    <div class="question-card">
                        <div class="question-number">${question.topic} â€¢ ${question.level} Level</div>
                        <div class="question-text">${question.text}</div>
                        <div class="question-input">
                            <input type="text" 
                                   class="assessment-answer-input" 
                                   id="assessmentAnswerInput" 
                                   placeholder="Your answer"
                                   inputmode="decimal"
                                   autocomplete="off"
                                   aria-label="Your answer to the question"
                                   onkeypress="if(event.key==='Enter') assessmentMode.submitAnswer()">
                            <button class="assessment-submit" onclick="assessmentMode.submitAnswer()">
                                Submit Answer â†’
                            </button>
                        </div>
                        <div id="assessmentFeedback" role="alert" aria-live="assertive"></div>
                    </div>
                `;
                
                // Focus input
                setTimeout(() => {
                    const input = document.getElementById('assessmentAnswerInput');
                    if (input) input.focus();
                }, 100);
            } catch (error) {
                console.error('Error showing question:', error);
            }
        },
        
        submitAnswer() {
            const input = document.getElementById('assessmentAnswerInput');
            const feedback = document.getElementById('assessmentFeedback');
            const question = this.questions[this.currentQuestion];
            
            if (!input || !input.value.trim()) {
                if (feedback) {
                    feedback.innerHTML = `<div class="assessment-feedback incorrect">Please enter an answer!</div>`;
                }
                return;
            }
            
            const userAnswer = parseFloat(input.value.trim());
            const expectedAnswer = parseFloat(question.answer);
            const isCorrect = Math.abs(userAnswer - expectedAnswer) < 0.01;
            
            // Store result
            this.answers.push({
                question: question.text,
                userAnswer: input.value,
                expectedAnswer: question.answer,
                correct: isCorrect,
                topic: question.topic
            });
            
            if (isCorrect) {
                this.score++;
                if (feedback) {
                    feedback.innerHTML = `<div class="assessment-feedback correct">âœ“ Correct! Great job!</div>`;
                }
            } else {
                if (feedback) {
                    feedback.innerHTML = `<div class="assessment-feedback incorrect">âœ— Not quite. The answer is ${question.answer}</div>`;
                }
            }
            
            // Disable input and button
            input.disabled = true;
            
            // Move to next question or show results
            setTimeout(() => {
                this.currentQuestion++;
                if (this.currentQuestion < this.questions.length) {
                    this.showQuestion();
                } else {
                    this.showResults();
                }
            }, 1500);
        },
        
        showResults() {
            const content = document.getElementById('assessmentContent');
            const progress = document.getElementById('assessmentProgress');
            const progressText = document.getElementById('assessmentProgressText');
            
            // Update progress to 100%
            if (progress) progress.style.width = '100%';
            if (progressText) progressText.textContent = 'Assessment Complete!';
            
            // Calculate grade recommendation
            const percentage = (this.score / this.questions.length) * 100;
            const recommendation = this.getRecommendation(percentage);
            
            // Store results
            localStorage.setItem('lastAssessmentScore', this.score);
            localStorage.setItem('lastAssessmentDate', new Date().toISOString());
            localStorage.setItem('recommendedGrade', recommendation.grade);
            
            if (content) {
                content.innerHTML = `
                    <div class="results-card">
                        <div class="results-hero">
                            <div class="results-icon">${recommendation.emoji}</div>
                            <h2 class="results-title">Assessment Complete!</h2>
                            <p class="results-subtitle">Here's how you did</p>
                        </div>
                        
                        <div class="results-score">
                            <div class="score-value">${this.score}/${this.questions.length}</div>
                            <div class="score-label">${Math.round(percentage)}% Correct</div>
                        </div>
                        
                        <div class="results-recommendation">
                            <div class="recommendation-title">ğŸ“š Recommended Starting Point</div>
                            <div class="recommendation-grade">${recommendation.gradeLabel}</div>
                            <p class="recommendation-text">${recommendation.message}</p>
                        </div>
                        
                        <div class="results-actions">
                            <button class="btn-start-learning" onclick="assessmentMode.startLearning('${recommendation.grade}')">
                                Start Learning at ${recommendation.gradeLabel} â†’
                            </button>
                            <button class="btn-retake" onclick="assessmentMode.start()">
                                ğŸ”„ Retake Assessment
                            </button>
                            <button class="btn-secondary" onclick="assessmentMode.closeResults()">
                                Explore All Topics
                            </button>
                        </div>
                    </div>
                `;
            }
        },
        
        getRecommendation(percentage) {
            // Smart grade recommendation based on which questions were answered correctly
            const lastCorrectIndex = this.answers.reduce((maxIndex, answer, index) => {
                return answer.correct ? index : maxIndex;
            }, -1);
            
            let grade, gradeLabel, emoji, message;
            
            if (percentage >= 90) {
                grade = '8';
                gradeLabel = '8th Grade';
                emoji = 'ğŸ†';
                message = 'Excellent work! You\'re ready for 8th grade math and beyond.';
            } else if (percentage >= 80) {
                grade = '7';
                gradeLabel = '7th Grade';
                emoji = 'ğŸŒŸ';
                message = 'Great job! You\'re well-prepared for 7th grade math concepts.';
            } else if (lastCorrectIndex >= 6) {
                grade = '7';
                gradeLabel = '7th Grade';
                emoji = 'ğŸ’ª';
                message = 'You\'re ready for 7th grade! Focus on strengthening these concepts.';
            } else if (lastCorrectIndex >= 5) {
                grade = '6';
                gradeLabel = '6th Grade';
                emoji = 'ğŸ¯';
                message = 'Perfect! 6th grade concepts will help you build a strong foundation.';
            } else if (lastCorrectIndex >= 4) {
                grade = '5';
                gradeLabel = '5th Grade';
                emoji = 'ğŸ“';
                message = '5th grade is a great place to start mastering these skills!';
            } else if (lastCorrectIndex >= 3) {
                grade = '4';
                gradeLabel = '4th Grade';
                emoji = 'âœï¸';
                message = '4th grade math will help you build confidence and understanding.';
            } else if (lastCorrectIndex >= 2) {
                grade = '3';
                gradeLabel = '3rd Grade';
                emoji = 'ğŸ“š';
                message = 'Start with 3rd grade to build a solid mathematical foundation.';
            } else if (lastCorrectIndex >= 1) {
                grade = '2';
                gradeLabel = '2nd Grade';
                emoji = 'ğŸŒ±';
                message = 'Beginning with 2nd grade will set you up for success!';
            } else {
                grade = '1';
                gradeLabel = '1st Grade';
                emoji = 'ğŸ“';
                message = 'Let\'s start from the beginning and build your math skills step by step!';
            }
            
            return { grade, gradeLabel, emoji, message };
        },
        
        startLearning(grade) {
            // Close assessment and set the grade in main app
            const container = document.getElementById('assessmentMode');
            if (container) {
                container.classList.remove('active');
                document.body.style.overflow = '';
            }
            
            // Set grade in main app
            const gradeSelect = document.getElementById('gradeSelect');
            if (gradeSelect && app) {
                gradeSelect.value = grade;
                app.currentGrade = grade;
                app.updateTopics();
                
                // Smooth scroll to content
                setTimeout(() => {
                    const controls = document.querySelector('.controls');
                    if (controls) {
                        controls.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
        },
        
        closeResults() {
            const container = document.getElementById('assessmentMode');
            if (container) {
                container.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
    };
    
    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize quick start modal
        quickStartModal.init();
        
        // Add Escape key handler for modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Close confirmation modal first if open
                const confirmModalEl = document.getElementById('confirmModal');
                if (confirmModalEl && confirmModalEl.classList.contains('show')) {
                    confirmModal.close();
                    return;
                }
                
                // Close quick start modal
                const modal = document.getElementById('quickStartModal');
                if (modal && modal.classList.contains('show')) {
                    quickStartModal.close();
                    return;
                }
                
                // Exit assessment on Escape with confirmation (consistent with exit button)
                const assessment = document.getElementById('assessmentMode');
                if (assessment && assessment.classList.contains('active')) {
                    // Use exit() method to show confirmation dialog
                    assessmentMode.exit();
                }
            }
        });
        
        // Feedback menu toggle
        const feedbackBtn = document.getElementById('feedbackBtn');
        const feedbackMenu = document.getElementById('feedbackMenu');
        
        if (feedbackBtn && feedbackMenu) {
            feedbackBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                feedbackMenu.classList.toggle('show');
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', () => {
                feedbackMenu.classList.remove('show');
            });
            
            // Prevent menu close when clicking inside
            feedbackMenu.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
        
        // Initialize competitions widget
        competitionsWidget.init();
    });
    </script>
    
    <script>
    // ============================================
    // COMPETITIONS WIDGET CONTROLLER
    // ============================================
    const competitionsWidget = {
        activityTimer: null,
        activityStartTime: null,
        isActive: false,
        hasShownWidget: false,
        isTestOrQuizActive: false,
        ACTIVITY_THRESHOLD: 300000, // 300 seconds = 5 minutes in milliseconds
        
        init() {
            // Check if widget was already dismissed
            const dismissed = sessionStorage.getItem('competitionsWidgetDismissed');
            if (dismissed === 'true') {
                return;
            }
            
            // Start tracking activity
            this.startActivityTracking();
            
            // Listen for practice completion
            this.listenForCompletion();
            
            // Monitor for test/quiz activity
            this.monitorTestQuizActivity();
        },
        
        startActivityTracking() {
            this.activityStartTime = Date.now();
            this.isActive = true;
            
            // Check activity every 10 seconds
            this.activityTimer = setInterval(() => {
                if (!this.isActive || this.hasShownWidget || this.isTestOrQuizActive) {
                    return;
                }
                
                const elapsed = Date.now() - this.activityStartTime;
                
                // Show widget after 300 seconds of activity on non-test/quiz pages
                if (elapsed >= this.ACTIVITY_THRESHOLD) {
                    this.show();
                    clearInterval(this.activityTimer);
                }
            }, 10000); // Check every 10 seconds
            
            // Reset timer on user interaction
            const resetActivity = () => {
                this.activityStartTime = Date.now();
            };
            
            document.addEventListener('click', resetActivity);
            document.addEventListener('keypress', resetActivity);
            document.addEventListener('scroll', resetActivity);
        },
        
        listenForCompletion() {
            // Listen for custom practice completion events
            document.addEventListener('practiceCompleted', () => {
                setTimeout(() => {
                    if (!this.hasShownWidget && !this.isTestOrQuizActive) {
                        this.show();
                    }
                }, 2000);
            });
            
            // Also listen for correct answers with a streak
            document.addEventListener('correctAnswer', (e) => {
                const streak = e.detail?.streak || 0;
                // Show widget after 3 correct answers in a row
                if (streak >= 3) {
                    setTimeout(() => {
                        if (!this.hasShownWidget && !this.isTestOrQuizActive) {
                            this.show();
                        }
                    }, 2000);
                }
            });
        },
        
        monitorTestQuizActivity() {
            // Monitor for assessment mode or timed activities
            const checkTestQuizStatus = () => {
                const assessmentMode = document.getElementById('assessmentMode');
                const isAssessmentActive = assessmentMode && 
                    assessmentMode.style.display !== 'none' && 
                    !assessmentMode.classList.contains('hidden');
                
                // Check for any timed test indicators in the content
                const contentArea = document.getElementById('contentArea');
                const hasTimedContent = contentArea && (
                    contentArea.innerHTML.includes('timer') ||
                    contentArea.innerHTML.includes('test') ||
                    contentArea.innerHTML.includes('quiz')
                );
                
                this.isTestOrQuizActive = isAssessmentActive || hasTimedContent;
                
                // Hide widget if test/quiz becomes active
                if (this.isTestOrQuizActive) {
                    this.hide();
                }
            };
            
            // Check periodically
            setInterval(checkTestQuizStatus, 2000);
            
            // Also check on DOM changes
            const observer = new MutationObserver(checkTestQuizStatus);
            const contentArea = document.getElementById('contentArea');
            if (contentArea) {
                observer.observe(contentArea, { childList: true, subtree: true });
            }
        },
        
        show() {
            if (this.hasShownWidget || this.isTestOrQuizActive) {
                return;
            }
            
            const widget = document.getElementById('competitionsWidget');
            if (widget) {
                widget.classList.add('show');
                widget.classList.remove('hide');
                this.hasShownWidget = true;
            }
        },
        
        hide() {
            const widget = document.getElementById('competitionsWidget');
            if (widget) {
                widget.classList.remove('show');
                widget.classList.add('hide');
            }
        },
        
        close() {
            this.hide();
            sessionStorage.setItem('competitionsWidgetDismissed', 'true');
            
            // Clear activity timer
            if (this.activityTimer) {
                clearInterval(this.activityTimer);
            }
        }
    };
    </script>
</body>
</html>

